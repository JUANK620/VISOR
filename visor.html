<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Visor de Retenciones con Filtro y Eliminación de Duplicados</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ccc; padding: 8px; }
        th { background-color: #f4f4f4; }
        .numeric { text-align: right; }
    </style>
</head>
<body>

<h2>Visor de Retenciones</h2>

<div>
    <label for="filterSelect">Mostrar:</label>
    <select id="filterSelect">
        <option value="Todos">Todos</option>
        <option value="RET IVA">RET IVA</option>
        <option value="RET FUENTE">RET FUENTE</option>
    </select>
    <input type="file" id="fileInput" multiple />
    <button onclick="exportTableToExcel()">Exportar a Excel</button>
    <button onclick="eliminarDuplicados()">Eliminar Duplicados</button>
</div>

<table id="invoicesTable">
    <thead>
        <tr>
            <th>No.</th>
            <th>Clave de Acceso</th>
            <th>Fecha de Emisión</th>
            <th>RUC</th>
            <th>Razón Social</th>
            <th class="numeric">Base Imponible</th>
            <th class="numeric">Porcentaje Retener</th>
            <th class="numeric">Valor Retenido</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
        <tr>
            <th colspan="5">Totales:</th>
            <th class="numeric" id="baseImponibleAcum">0.00</th>
            <th></th>
            <th class="numeric" id="valorRetenidoAcum">0.00</th>
            <th></th>
        </tr>
    </tfoot>
</table>

<script>
    let allRecords = [];

    function formatNumber(val) {
        return Number(val).toFixed(2);
    }

    function updateTotals(records) {
        let totalBase = 0;
        let totalValor = 0;
        records.forEach(record => {
            totalBase += parseFloat(record.baseImponible) || 0;
            totalValor += parseFloat(record.valorRetenido) || 0;
        });
        document.getElementById("baseImponibleAcum").textContent = formatNumber(totalBase);
        document.getElementById("valorRetenidoAcum").textContent = formatNumber(totalValor);
    }

    function renderTable() {
        const tbody = document.querySelector("#invoicesTable tbody");
        tbody.innerHTML = "";
        const filterValue = document.getElementById("filterSelect").value;
        const filteredRecords = allRecords.filter(record => filterValue === "Todos" || record.tipoRetencion === filterValue);

        filteredRecords.forEach(record => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${record.noDocumento}</td>
                <td>${record.claveAcceso}</td>
                <td>${record.fechaEmision}</td>
                <td>${record.ruc}</td>
                <td>${record.razonSocial}</td>
                <td class="numeric">${formatNumber(record.baseImponible)}</td>
                <td class="numeric">${record.porcentajeRetener}</td>
                <td class="numeric">${formatNumber(record.valorRetenido)}</td>
                <td>
                    <button onclick="verDetalle('${encodeURIComponent(JSON.stringify(record))}')">Detalles</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        updateTotals(filteredRecords);
    }

    function verDetalle(recordStr) {
        const record = JSON.parse(decodeURIComponent(recordStr));
        alert(`
Detalles de Retención:
No.: ${record.noDocumento}
Clave de Acceso: ${record.claveAcceso}
Fecha de Emisión: ${record.fechaEmision}
RUC: ${record.ruc}
Razón Social: ${record.razonSocial}
Base Imponible: ${formatNumber(record.baseImponible)}
Porcentaje Retener: ${record.porcentajeRetener}
Valor Retenido: ${formatNumber(record.valorRetenido)}
Documento Sustento: ${record.numDocSustento || 'No disponible'}
Fecha Emisión Sustento: ${record.fechaEmisionDocSustento || 'No disponible'}
        `);
    }

    function eliminarDuplicados() {
        const seen = {};
        allRecords = allRecords.filter(rec => {
            const key = rec.claveAcceso + "|" + rec.tipoRetencion;
            return seen[key] ? false : (seen[key] = true);
        });
        renderTable();
        alert("Duplicados eliminados.");
    }

    document.getElementById("filterSelect").addEventListener("change", renderTable);

    document.getElementById("fileInput").addEventListener("change", function (event) {
        const files = event.target.files;
        if (files.length === 0) {
            alert("Selecciona al menos un archivo XML.");
            return;
        }
        allRecords = [];
        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function (e) {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(e.target.result, "text/xml");
                const comprobanteCDATAText = xmlDoc.getElementsByTagName("comprobante")[0]?.textContent.trim();
                const retencionXML = parser.parseFromString(comprobanteCDATAText, "text/xml");
                const infoTrib = retencionXML.getElementsByTagName("infoTributaria")[0];
                const infoComp = retencionXML.getElementsByTagName("infoCompRetencion")[0];

                const record = {
                    noDocumento: infoTrib.getElementsByTagName("secuencial")[0]?.textContent.trim(),
                    claveAcceso: infoTrib.getElementsByTagName("claveAcceso")[0]?.textContent.trim(),
                    fechaEmision: infoComp.getElementsByTagName("fechaEmision")[0]?.textContent.trim(),
                    ruc: infoTrib.getElementsByTagName("ruc")[0]?.textContent.trim(),
                    razonSocial: infoTrib.getElementsByTagName("razonSocial")[0]?.textContent.trim(),
                    baseImponible: infoComp.getElementsByTagName("baseImponible")[0]?.textContent.trim(),
                    porcentajeRetener: infoComp.getElementsByTagName("porcentajeRetener")[0]?.textContent.trim(),
                    valorRetenido: infoComp.getElementsByTagName("valorRetenido")[0]?.textContent.trim(),
                    numDocSustento: infoComp.getElementsByTagName("numDocSustento")[0]?.textContent.trim(),
                    fechaEmisionDocSustento: infoComp.getElementsByTagName("fechaEmisionDocSustento")[0]?.textContent.trim()
                };

                allRecords.push(record);
                renderTable();
            };
            reader.readAsText(file);
        });
    });
</script>
</body>
</html>
