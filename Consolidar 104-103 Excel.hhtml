<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRI - Reporte Consolidado Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #1e40af; --accent: #3b82f6; --bg: #f8fafc; --text: #0f172a; }
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: auto; }
        
        .header { text-align: center; margin-bottom: 30px; }
        .upload-zone { background: white; border: 2px dashed #cbd5e1; padding: 40px; border-radius: 20px; text-align: center; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .upload-zone:hover { border-color: var(--accent); background: #eff6ff; }

        .table-container { background: white; border-radius: 12px; margin-top: 30px; overflow-x: auto; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); display: none; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        
        th { background: #f1f5f9; padding: 15px; text-align: left; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #475569; border-bottom: 2px solid #e2e8f0; }
        td { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; vertical-align: middle; }
        
        .code-badge { background: #e2e8f0; padding: 4px 8px; border-radius: 6px; font-family: monospace; font-weight: bold; font-size: 0.85rem; }
        .desc-text { font-weight: 600; color: #334155; }
        .val-num { text-align: right; font-family: 'JetBrains Mono', monospace; font-weight: 500; }
        .col-header { text-align: right; background: #f8fafc; }
        .col-id { display: block; color: var(--accent); font-size: 0.65rem; font-weight: 800; }
        
        .controls { display: none; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .btn-excel { background: #16a34a; color: white; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-excel:hover { background: #15803d; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1> SRI Reporte Consolidado</h1>
        <p>NUMERO DEL FORMULARIO 103 y 104</p>
    </div>

    <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
        <h2 style="margin:0"> Seleccionar PDFs de IVA o Retenciones</h2>
        <p style="color:#64748b">Puedes subir varios meses a la vez (Enero, Febrero, Marzo...)</p>
        <input type="file" id="fileInput" multiple accept="application/pdf" style="display:none">
    </div>

    <div class="controls" id="controls">
        <div id="fileStatus" style="font-weight: 600; color: #1e40af;"></div>
        <button class="btn-excel" onclick="exportarExcel()">Descargar Reporte en Excel</button>
    </div>

    <div class="table-container" id="tableContainer">
        <table id="dataTable">
            <thead id="tHead"></thead>
            <tbody id="tBody"></tbody>
        </table>
    </div>
</div>

<script>
    // DICCIONARIO UNIFICADO CON ABREVIATURAS V.B. / V.N. / IMP.
    const diccSRI = {
        // FORMULARIO 103 - RETENCIONES
        "302": "B.I. En relaciOn de dependencia que supera o no la base desgravada",
        "352": "RET. RetenciOn: RelaciOn de dependencia",
        "303": "B.I. Honorarios profesionales y servicios relacionados con el intelecto",
        "353": "RET. RetenciOn: Honorarios profesionales (Sociedades/Personas)",
        "3030": "Servicios profesionales prestados por sociedades residentes",
        "3530": "RetenciOn: Servicios profesionales sociedades",
        "304": "Servicios donde predomina el intelecto (no profesionales)",
        "332": "Pagos de bienes y servicios no sujetos a retenciOn o con 0% (distintos de rendimientos financieros)",
        "343": "B.I. Pagos aplicables el 1%",
		"393": "RET. Pagos aplicables el 1%",
        "3440": "B.I. Aplicables el 2,75%",
		"3940": "RET. Aplicables el 2,75%",
        "349":  "B.I. SUBTOTAL OPERACIONES EFECTUADAS EN EL PAÍS",
		"399":  "RET. SUBTOTAL OPERACIONES EFECTUADAS EN EL PAÍS",
        "354": "RetenciOn: Servicios intelecto no profesionales",
        "307": "Servicios donde predomina la mano de obra",
        "357": "RetenciOn: Mano de obra",
        "310": "B.I. Servicios prestados por medios de comunicaciOn y agencias de publicidad",
        "360": "RET. RetenciOn: Medios de comunicaciOn",
        "312": "B.I. Transferencia de bienes muebles de naturaleza corporal",
        "362": "RET. RetenciOn: Transferencia de bienes muebles",
        "319": "B.I. Arrendamiento de bienes inmuebles Mercantil",
        "369": "RET. RetenciOn: Arrendamiento Mercantil",
        "320": "B.I. Arrendamiento de bienes inmuebles",
        "370": "RET. RetenciOn: Arrendamiento",
        "322": "Por rendimientos financieros o intereses de cualquier tipo",
        "372": "RetenciOn: Rendimientos financieros",
        "344": "Otras retenciones aplicables el 2%",
        "394": "RetenciOn: Otras 2%",
        "499": "TOTAL DE RETENCI脫N DE IMPUESTO A LA RENTA",
        "902": "TOTAL IMPUESTO A PAGAR (Retenciones)",
        "999": "TOTAL PAGADO(Retenciones)",

        // FORMULARIO 104 - IVA
        "401": "Ventas locales (excluye activos fijos) gravadas tarifa diferente de cero",

  // Ventas y Exportaciones
  "401": "V.B. Ventas locales (excluye activos fijos) gravadas tarifa diferente de cero",
  "411": "V.N. Ventas locales (excluye activos fijos) gravadas tarifa diferente de cero",
  "421": "IMP. Ventas locales (excluye activos fijos) gravadas tarifa diferente de cero",
  "402": "V.B. Ventas de activos fijos gravadas tarifa diferente de cero",
  "412": "V.N. Ventas de activos fijos gravadas tarifa diferente de cero",
  "422": "IMP. Ventas de activos fijos gravadas tarifa diferente de cero",
  "410": "V.B. Ventas locales (excluye activos fijos) gravadas tarifa diferente de cero (TARIFA VARIABLE)",
  "420": "V.N. Ventas locales (excluye activos fijos) gravadas tarifa diferente de cero (TARIFA VARIABLE)",
  "430": "IMP. Ventas locales (excluye activos fijos) gravadas tarifa diferente de cero (TARIFA VARIABLE)",
  "425": "V.B. Ventas locales (excluye activos fijos) gravadas tarifa 5%",
  "435": "V.N. Ventas locales (excluye activos fijos) gravadas tarifa 5%",
  "445": "IMP. Ventas locales (excluye activos fijos) gravadas tarifa 5%",

  // Ajustes e Impuestos Específicos
  "423": "IMP. IVA generado en la diferencia entre ventas y notas de crEdito con distinta tarifa (ajuste a pagar)",
  "424": "IMP. IVA generado en la diferencia entre ventas y notas de crEdito con distinta tarifa (ajuste a favor)",

  // Ventas Tarifa 0% y Exportaciones
  "403": "V.B. Ventas locales (excluye activos fijos) gravadas tarifa 0% que no dan derecho a crEdito tributario",
  "413": "V.N. Ventas locales (excluye activos fijos) gravadas tarifa 0% que no dan derecho a crEdito tributario",
  "404": "V.B. Ventas de activos fijos gravadas tarifa 0% que no dan derecho a crEdito tributario",
  "414": "V.N. Ventas de activos fijos gravadas tarifa 0% que no dan derecho a crEdito tributario",
  "405": "V.B. Ventas locales (excluye activos fijos) gravadas tarifa 0% que dan derecho a crEdito tributario",
  "415": "V.N. Ventas locales (excluye activos fijos) gravadas tarifa 0% que dan derecho a crEdito tributario",
  "406": "V.B. Ventas de activos fijos gravadas tarifa 0% que dan derecho a crEdito tributario",
  "416": "V.N. Ventas de activos fijos gravadas tarifa 0% que dan derecho a crEdito tributario",
  "407": "V.B. Exportaciones de bienes",
  "417": "V.N. Exportaciones de bienes",
  "408": "V.B. Exportaciones de servicios y/o derechos",
  "418": "V.N. Exportaciones de servicios y/o derechos",

  // Totales y Otros
  "409": "V.B. TOTAL VENTAS Y OTRAS OPERACIONES",
  "419": "V.N. TOTAL VENTAS Y OTRAS OPERACIONES",
  "429": "IMP. TOTAL VENTAS Y OTRAS OPERACIONES",
  "431": "V.B. Transferencias de bienes y prestaciOn de servicios no objeto o exentos de IVA",
  "441": "V.N. Transferencias de bienes y prestaciOn de servicios no objeto o exentos de IVA",
  "442": "V.N. Notas de crEdito tarifa 0% por compensar prOximo mes",
  "443": "V.N. Notas de crEdito tarifa diferente de cero por compensar prOximo mes",
  "453": "IMP. Notas de crEdito tarifa diferente de cero por compensar prOximo mes",
  "434": "V.B. obtenidos por parte de las sociedades de gestiOn colectiva como intermediarios (informativo)",
  "444": "V.N. obtenidos por parte de las sociedades de gestiOn colectiva como intermediarios (informativo)",
  "454": "IMP. obtenidos por parte de las sociedades de gestiOn colectiva como intermediarios (informativo)",
  
  // --- NUEVOS CASILLEROS SEGÚN LA IMAGEN SUBIDA ---
"480": "Total transferencias gravadas tarifa diferente de cero a contado este mes",
"481": "Total transferencias gravadas tarifa diferente de cero a crEdito este mes",
"482": "Total impuesto generado",
"483": "Impuesto a liquidar del mes anterior",
"484": "Impuesto a liquidar en este mes",
"485": "Impuesto a liquidar en el prOximo mes",
"499": "TOTAL IMPUESTO A LIQUIDAR EN ESTE MES",

  // RESUMEN DE ADQUISICIONES Y PAGOS (FORMULARIO 104)
"500": "V.B. Adquisiciones y pagos (excluye activos fijos) gravados tarifa diferente de cero (con derecho a crEdito tributario)",
"510": "V.N. Adquisiciones y pagos (excluye activos fijos) gravados tarifa diferente de cero (con derecho a crEdito tributario)",
"520": "IMP. Adquisiciones y pagos (excluye activos fijos) gravados tarifa diferente de cero (con derecho a crEdito tributario)",

"501": "V.B. Adquisiciones locales de activos fijos gravados tarifa diferente de cero (con derecho a crEdito tributario)",
"511": "V.N. Adquisiciones locales de activos fijos gravados tarifa diferente de cero (con derecho a crEdito tributario)",
"521": "IMP. Adquisiciones locales de activos fijos gravados tarifa diferente de cero (con derecho a crEdito tributario)",

"508": "V.B. Adquisiciones a contribuyentes RISE / NEGOCIOS POPULARES",
"518": "V.N. Adquisiciones a contribuyentes RISE / NEGOCIOS POPULARES",

"509": "V.B. TOTAL ADQUISICIONES Y PAGOS",
"519": "V.N. TOTAL ADQUISICIONES Y PAGOS",
"529": "IMP. TOTAL ADQUISICIONES Y PAGOS",

"530": "V.B. Adquisiciones y pagos (excluye activos fijos) gravados tarifa diferente de cero tarifa variable",
"533": "V.N. Adquisiciones y pagos (excluye activos fijos) gravados tarifa diferente de cero tarifa variable",
"534": "IMP. Adquisiciones y pagos (excluye activos fijos) gravados tarifa diferente de cero tarifa variable",

"540": "V.B. Adquisiciones locales (excluye activos fijos) gravados tarifa 5% (con derecho a crEdito tributario)",
"550": "V.N. Adquisiciones locales (excluye activos fijos) gravados tarifa 5% (con derecho a crEdito tributario)",
"560": "IMP. Adquisiciones locales (excluye activos fijos) gravados tarifa 5% (con derecho a crEdito tributario)",

"502": "V.B. Otras adquisiciones y pagos gravados tarifa diferente de cero (sin derecho a crEdito tributario)",
"512": "V.N. Otras adquisiciones y pagos gravados tarifa diferente de cero (sin derecho a crEdito tributario)",
"522": "IMP. Otras adquisiciones y pagos gravados tarifa diferente de cero (sin derecho a crEdito tributario)",

"503": "V.B. Importaciones de servicios y/o derechos gravados tarifa diferente de cero",
"513": "V.N. Importaciones de servicios y/o derechos gravados tarifa diferente de cero",
"523": "IMP. Importaciones de servicios y/o derechos gravados tarifa diferente de cero",

"504": "V.B. Importaciones de bienes (excluye activos fijos) gravados tarifa diferente de cero",
"514": "V.N. Importaciones de bienes (excluye activos fijos) gravados tarifa diferente de cero",
"524": "IMP. Importaciones de bienes (excluye activos fijos) gravados tarifa diferente de cero",

"505": "V.B. Importaciones de activos fijos gravados tarifa diferente de cero",
"515": "V.N. Importaciones de activos fijos gravados tarifa diferente de cero",
"525": "IMP. Importaciones de activos fijos gravados tarifa diferente de cero",

"526": "IMP. IVA generado en diferencia adquisiciones y notas crEdito distinta tarifa (ajuste positivo)",
"527": "IMP. IVA generado en diferencia adquisiciones y notas crEdito distinta tarifa (ajuste negativo)",

"506": "V.B. Importaciones de bienes (excluye activos fijos) gravados tarifa 0%",
"516": "V.N. Importaciones de bienes (excluye activos fijos) gravados tarifa 0%",

"507": "V.B. Adquisiciones y pagos (incluye activos fijos) gravados tarifa 0%",
"517": "V.N. Adquisiciones y pagos (incluye activos fijos) gravados tarifa 0%",

"508": "V.B. Adquisiciones a contribuyentes RISE / NEGOCIOS POPULARES",
"518": "V.N. Adquisiciones a contribuyentes RISE / NEGOCIOS POPULARES",

"509": "V.B. TOTAL ADQUISICIONES Y PAGOS",
"519": "V.N. TOTAL ADQUISICIONES Y PAGOS",
"529": "IMP. TOTAL ADQUISICIONES Y PAGOS",

"531": "V.B. Adquisiciones no objeto de IVA",
"541": "V.N. Adquisiciones no objeto de IVA",

"532": "V.B. Adquisiciones exentas del pago de IVA",
"542": "V.N. Adquisiciones exentas del pago de IVA",

"543": "V.N. Notas de crEdito tarifa 0% por compensar prOximo mes",
"544": "V.N. Notas de crEdito tarifa diferente de cero por compensar prOximo mes",
"554": "IMP. Notas de crEdito tarifa diferente de cero por compensar prOximo mes",

"535": "V.B. Pagos netos por reembolso como intermediario",
"545": "V.N. Pagos netos por reembolso como intermediario",
"555": "IMP. Pagos netos por reembolso como intermediario",

// RESUMEN IMPOSITIVO Y RETENCIONES IVA
"601": "Impuesto causado",
"602": "CrEdito tributario aplicable en este periodo",
"605": "Saldo crEdito tributario mes anterior: Por adquisiciones e importaciones",
"606": "Saldo crEdito tributario mes anterior: Por retenciones en la fuente de IVA",
"609": "Retenciones en la fuente de IVA que le han sido efectuadas en este periodo",
"620": "SUBTOTAL A PAGAR",
"699": "TOTAL IMPUESTO A PAGAR POR PERCEPCION Y RETENCIONES",

"615": " Saldo crédito tributario para el próximo mes Por adquisiciones e importaciones ",
"617": "Saldo crédito tributario para el próximo mes Por retenciones en la fuente de IVA que le han sido efectuadas",

// AGENTE DE RETENCION
"799": "TOTAL IMPUESTO RETENIDO",
"801": "TOTAL IMPUESTO A PAGAR POR RETENCION",

"721": "RetenciOn del 10%",
"723": "RetenciOn del 20%",
"725": "RetenciOn del 30%",
"727": "RetenciOn del 50%",
"729": "RetenciOn del 70%",
"731": "RetenciOn del 100%",
"799": "TOTAL IMPUESTO RETENIDO",
"801": "TOTAL IMPUESTO A PAGAR POR RETENCION"


    };

    let periodos = [];
    let masterData = [];

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        let rawData = {}; 
        let casillerosSet = new Set();
        periodos = [];

        for (const file of files) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let text = "";
            for (let i=1; i<=pdf.numPages; i++){
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(s => s.str).join(" ") + " ";
            }

            const periodoMatch = text.match(/Per[í|i|铆]odo Fiscal:\s*([A-Z]+\s+\d{4})/i);
            const periodo = periodoMatch ? periodoMatch[1] : file.name.replace(".pdf", "");
            
            periodos.push(periodo);
            rawData[periodo] = {};

            const regex = /(\d{3,4})\s+(\d+\.\d{2})/g;
            let m;
            while ((m = regex.exec(text)) !== null) {
                const cod = m[1];
                const val = parseFloat(m[2]);
                if (val > 0) {
                    rawData[periodo][cod] = val;
                    casillerosSet.add(cod);
                }
            }
        }

        masterData = Array.from(casillerosSet).sort((a,b) => a - b).map(c => {
            let desc = (diccSRI[c] || "Otros valores / InformaciOn adicional").normalize("NFC");
            let row = { Codigo: c, Descripcion: desc };
            periodos.forEach(p => row[p] = rawData[p][c] || 0);
            return row;
        });

        renderTable();
    });

    function renderTable() {
        const head = document.getElementById('tHead');
        const body = document.getElementById('tBody');
        
        head.innerHTML = `<tr><th style="width:100px">CODIGO</th><th style="width:400px">DESCRIPCION</th>` + 
            periodos.map((p, i) => `<th class="col-header"><span class="col-id">COLUMNA ${i+1}</span>${p}</th>`).join('') + `</tr>`;
        
        body.innerHTML = masterData.map(row => `
            <tr>
                <td><span class="code-badge">${row.Codigo}</span></td>
                <td class="desc-text">${row.Descripcion}</td>
                ${periodos.map(p => `<td class="val-num">$ ${row[p].toLocaleString('en-US',{minimumFractionDigits:2})}</td>`).join('')}
            </tr>
        `).join('');

        document.getElementById('controls').style.display = 'flex';
        document.getElementById('tableContainer').style.display = 'block';
        document.getElementById('fileStatus').innerText = `Procesados ${periodos.length} archivos con Exito.`;
    }

    function exportarExcel() {
        const ws = XLSX.utils.json_to_sheet(masterData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "SRI_Consolidado");
        XLSX.writeFile(wb, "Reporte_SRI_Final.xlsx");
    }
</script>

</body>
</html>
